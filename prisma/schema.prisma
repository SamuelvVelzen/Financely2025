// ----------
// Prisma setup
// ----------

generator client {
  provider = "prisma-client-js"
}

generator zod {
  provider                 = "prisma-zod-generator"
  output                   = "../src/features/shared/validation/generated.ts"
  createInputTypes         = true
  writeNullishInOptionalTypes = false
  useDecimalJs             = false
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ----------
// Enums
// ----------

enum TransactionType {
  EXPENSE
  INCOME
}

enum MessageType {
  INFO
  SUCCESS
  WARNING
  ERROR
}

enum TimePrecision {
  DateTime
  DateOnly
}

// ----------
// Models
// ----------

// ----------
// BetterAuth Tables
// ----------

// UserInfo table (used by BetterAuth for authentication)
// Contains auth fields + user profile information
model UserInfo {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Profile fields
  firstName     String
  lastName      String
  suffix        String?
  name          String?   // Display name (computed from firstName suffix lastName)

  // BetterAuth relations
  accounts      Account[]
  sessions      Session[]

  // App domain relation (1-to-1)
  user          User?
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  userInfo              UserInfo @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userInfo  UserInfo @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
}

// ----------
// App Domain Models
// ----------

// User table (app-specific data)
// Contains relations to transactions, tags, and other app entities
model User {
  id            String         @id @default(cuid())
  userInfoId    String         @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relation to BetterAuth UserInfo
  userInfo      UserInfo       @relation(fields: [userInfoId], references: [id], onDelete: Cascade)

  // App domain relations
  transactions  Transaction[]
  tags          Tag[]
  messages      Message[]
  budgets       Budget[]
}

model Transaction {
  id            String           @id @default(cuid())
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String

  type          TransactionType
  amount        Decimal
  currency      String
  transactionDate DateTime       // Authoritative calendar date for day-based operations
  timePrecision TimePrecision   @default(DateTime) // DateTime = date + time known, DateOnly = date known, time unknown

  name          String
  description   String?
  notes         String?
  externalId    String?
  paymentMethod String

  // many-to-many relation to tags
  tags          Tag[] 

  // primary tag for budget sorting and display
  primaryTagId  String?
  primaryTag    Tag?             @relation("PrimaryTag", fields: [primaryTagId], references: [id])

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@index([userId, transactionDate])
  @@index([userId, type, transactionDate])
}

model Tag {
  id            String           @id @default(cuid())
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String

  name          String
  color         String?           // optional color like #FF6600
  description   String?
  emoticon      String?           // optional emoticon/emoji
  order         Int
  transactionType TransactionType // EXPENSE = expense only, INCOME = income only

  transactions  Transaction[]
  primaryTransactions Transaction[] @relation("PrimaryTag")
  budgetItems   BudgetItem[]

  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  @@unique([userId, name])
}

model Message {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  content     String
  type        MessageType @default(INFO)
  
  // Actions stored as JSON array
  // Example: [{"label": "View Subscriptions", "type": "navigate", "path": "/subscriptions"}, {"label": "Dismiss", "type": "dismiss"}]
  actions     String?     // JSON string of IMessageAction[]
  
  read        Boolean     @default(false)
  readAt      DateTime?
  
  // Optional metadata for linking to related entities
  relatedId   String?     // e.g., transaction ID, tag ID, etc.
  relatedType String?     // e.g., "transaction", "tag", "subscription"
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([userId, type])
}

model Budget {
  id            String         @id @default(cuid())
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String

  name          String
  startDate     DateTime
  endDate       DateTime
  currency      String

  items         BudgetItem[]

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([userId, startDate, endDate])
}

model BudgetItem {
  id            String         @id @default(cuid())
  budget        Budget         @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  budgetId      String

  tagId         String?        // null means "Misc" for untagged transactions
  tag           Tag?           @relation(fields: [tagId], references: [id], onDelete: SetNull)
  expectedAmount Decimal

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([budgetId, tagId])
}
